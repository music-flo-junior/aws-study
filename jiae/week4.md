# 4. Amazon EC2 인스턴스

# 1. Amazon EC2의 장점

- 빠른 제품 출시
    - 신규 프로젝트 자원 신속 확보
- 확장성
    - 피크 타임을 대비한 과잉 프로비전의 필요성이 없어짐
    - 스케일업 다운을 이용한 성능 최대화 및 비용 최소화
- 통제성
    - 데이터 센터와 같이 EC2 서버 완벽 제어
- 신뢰성
    - EC2 서비스 수준 계약 (SLA)의 리전별 가용성 99.95%
- 보안성
    - 보안 시설, VPC 와 네트워크 보안 설정 가능
- 다양한 인스턴스 타입
- 통합
    - 다양한 AWS 서비스와 통합 사용 가능
- 비용 효율성
    - 시간당 또는 초당 비용 부담

### EC2가 지원하는 운영체제

- Windows, Amazon, Linux, Debian, SUSE, CentOS, Red Hat Enterprise Linux, Ubuntu

# 2. Amazon EC2 인스턴스 타입과 특징

## 2.1 범용 인스턴스

- T3, T3a, T2, M6g, M5, M5a, M5n, M4, A1
- 컴퓨팅 파워와 메모리, 네트워크 등 리소스의 균형을 맞춘 인스턴스 타입
- T3, T2
    - 평균 수준의 CPU 파워를 기본으로 하되, 처리량 급증 시 성능 가속 기능 추가
        - 성능가속: 오버클럭 같은거
    - 완전 CPU 활성화가 필요없는 워크로드에 적합 (웹 서버, 개발환경 등)
- M5, M5n, M4
    - 웹 사이트 빌드, 개발 환경, 서버 빌드, 코드 저장소, 마이크로서비스, 테스트 환경 등 다양한 용도로 사용 (성능 가속 기능 없음.)
- M1, M6g
    - Arm 기반 프로세서

## 2.2 컴퓨트 최적화 인스턴스

- C6g, C5, C5a, C5n, C4
- 고도의 컴퓨팅 파워가 요구되는 워크로드 처리
- 미디어 변환, 다수의 동시 접속자가 사용하는 애플리케이션 지원, 장기간 실행되는 배치 프로세싱, 고성능 컴퓨팅, 게임 서버 등

## 2.3 메모리 최적화 인스턴스

- 고성능 메모리 요구 워크로드 처리
- R6g, R5, R5a, R5n, R4, X1e, X1, High Memory, Z1d
- SAP HANA, Oracle 인메모리 데이터베이스, MongoDB 또는 Cassandra 와 같은 NoSQL 데이터베이스, Resto 또는 Apache Spark 와 같은 빅데이터 엔진 등에서 사용

## 2.4 스토리지 최적화 인스턴스

- i3, I3en, D2, H1
- 스토리지에 최적화되어 있으므로 매우 낮은 전송 지연 및 랜덤 IOPS 수준
- I/O 바운드 애플리케이션이 실행되는 관계형 데이터베이스, NoSQL 데이터베이스, 데이터 웨어하우스, 애플리케이션, Redis 등 인메모리 데이터베이스 및 MapReduce 및 Hadoop 분산 캐시 등의 목적으로 사용

## 2.5 고성능 컴퓨트 인스턴스

- P3, P2,, Inf1, G4, G3, F1
- 머신러닝, 세포 모델링, 유전공학, 유체 역학, 자율주행, 신약 개발, 지질 탐사, 금융 공학 등 탁월한 수준의 컴퓨팅 파워가 요구되는 워크로드 처리
- GPU, FPGAField Programmable Gate Arrays 등 하드웨어 기반 가속기 지원

# 3. Amazon EC2 활용 프로세스

## 3.1 Intel AES New Instructions(AES-NI)

- AES(Advanced Encryption Standard) 알고리즘 적용 암호화 기능 적용

## 3.2 Intel Advanced Vector Extensions(AVX)

- 이미지 및 오디오/비디오 프로세싱 애플리케이션 성능 증가

## 3.3 Intel Turbo Boost Technology

- 트래픽 급증 등 필요시에 즉각적으로 성능을 높여준다.

## 3.4 Intel Deep Learning Boost

- AI 딥러닝 최적화 프로세서

# 4. 네트워크 특징

- EC2 인스턴스는 항상 VPC 내부에 론칭하는 것이 좋다.
- 플레이스먼트 그룹은 단일 AZ 내에서 인스턴스를 논리적 그룹으로 묶는 방법으로, 낮은 지연성과 높은 수준의 네트워크 처리 성능을 제공한다.
⇒ 클러스터 네트워킹
- 플레이스먼트 그룹에 인스턴스를 론칭하면 EC2 인스턴스는 단일 트래픽 흐름에 최대 10Gbps 의 네트워크 처리 성능을 활용할 수 있다.
- 플레이스먼트 그룹을 최대한 활용하기 위해 Linux에서 향상된 네트워킹을 지원하는 인스턴스 타입을 선택한다.

# 5. 스토리지 특징

EC2 인스턴스에 부착해 사용하는 블록 스토리지는 Amazon EBS(Elastic Block Storage)다.

EBS 볼륨은 세 가지 타입이 있다.

- 범용 스토리지(GP2)
    - SSD 기반의 범용 EBS 볼륨으로 일반적인 목적에 적합
- 프로비전 IOPS(PIOPS) 스토리지
    - 데이터베이스 워크로드 실행 등 대량의 I/O 작업이 수반되는 컴퓨팅 작업에 적합
- 마그네틱 스토리지
    - 중요성이 낮은 워크로드, 데이터 접근이 잦은 다른 워크로드 처리에 적합

### 인스턴스 스토어

- EC2 인스턴스를 삭제하면 인스턴스 스토어도 함께 사라짐
- 데이터를 안전하게 보호하기 위해서는 인스턴스 스토어 외에도 EBS에 저장 필요

### EBS 최적화 인스턴스

- EBS 볼륨에서 최대체의 프로비전 IOPS를 활용 가능
- 일부 EC2 인스턴스는 클러스터 네트워킹 지원 (플레이스먼트 그룹)

### Amazon EC2 사용 방법

1. 이미지(AMI) 선택
2. 네트워크 및 보안 환경 설정(VPC, 퍼블릭, 프라이빗 서브넷)
3. 인스턴스 타입 선택
4. AZ 선택 및 EBS 부착
5. 인스턴스 시작

# 5,  Amazon EC2 가격 정책

## 5.1 온디맨드 인스턴스

- 인스턴스 사용 기간에 따라 시간당 요금제 또는 초당 과금제로 비용 지불

## 5.2 예약 인스턴스

- 예약 인스턴스는 사용량이 거의 확정된 프로덕션 워크로드용 인스턴스 실행에 적합
- 기업 어플리케이션에 대한 트래픽이 안정적이거나 성능에 대한 요구 수준이 예측 가능한 경우 선택
- 리전 또는 특정 AZ 인스턴스 예약 가능
- 전환 예약 인스턴스 계약에서는 사용자의 컴퓨팅 요구 변화를 반영해 하나의 클래스에서 또 다른 클래스로 인스턴스 타입 변경 가능

## 5.3 스팟 인스턴스

- AWS는 일시적으로 여유가 생긴 컴퓨팅 자원을 사용자에게 경매 입찰 방식으로 제공
- AWS 고객 중 상당수는 온디맨드 인스턴스를 기본으로 하고 컴퓨팅 성능을 높이기 위해 스팟 인스턴스 활용

### 스팟 인스턴스 활용 전략

- 컨테이너화된 모든 것
- Apache Spark 및 Hadoop 같은 빅데이터 프레임워크
- 빅데이터 일괄 처리
- 스테이트리스 웹 서비스
- 머신 러닝
- Jenkins CI/CD

# 6. 공유 테넌시, 전용 호스트, 전용 인스턴스

## 6.1 공유 테넌시

- EC2 인스턴스를 멀티 테넌시 하드웨어에서 실행

## 5.2 전용 호스트

- 전용 호스트는 특정 사용자에게만 배타적으로 할당된 물리적 서버

## 5.3 전용 인스턴스

- 단일 테넌트 하드웨어에서 EC2 인스턴스를 실행하며 개별 사용자에게만 할당된 하드웨어의 VPC에서 Amazon EC2 인스턴스를 실행
- 베어 메탈 인스턴스는 서버의 프로세서 및 메모리 자원에 직접 접근할 수 있음.

# 7. 인스턴스와 AMI

- Amazon 머신 이미지
- 모든 소프트웨어 환경 설정 정보를 포함한 기본 설계도 또는 청사진
- 루트 볼륨
    - 운영체제와 애플리케이션 서버 포함
- 론칭 승인 정보
    - 퍼블릭(Public): 모든 AWS 사용자  론칭 승인 부여
    - 명시적(Explicit): 특정 AWS 사용자 론칭 승인 부여
    - 암시적(Implicit): 암묵적으로 AMI를 통한 론칭 승인 부여
- 블록 디바이스 맵핑 정보 포함
    - 어떤 볼륨 타입을 부착할지를 정의한 정보
- 특정 리전에서는 론칭할 수 있는 인스턴스 수에 제한이 있다.
    - 기본 제한사항이므로 지원 티켓으로 인스턴스 수 제한을 풀 수도 있음.

### 인스턴스 루트 볼륨(Instance Root Volume)

- 인스턴스 루트 디바이스에는 부팅을 위한 이미지 포함
- 인스턴스 스토어 기반 AMI
    - S3를 통해 백업되는 인스턴스 루트 디바이스
    - 중지 동작 지원 안함. 인스턴스 삭제되면 데이터 복구 불가
    - 인스턴스 스토어 외 추가 저장 필요
    
- EBS 기반 AMI
    - EBS 스냅샷을 통해 생성되는 인스턴스 루트 디바이스
    - 중지 동작 지원. 인스턴스 실패 및 삭제시에도 데이터 유지
    

### AMI 선택하기

- 사용자는 자신의 니즈에 맞는 AMI를 만든 뒤 이를 템플릿으로 해서 인스턴스를 론칭할 때 사용할 수 있고, 개발자 커뮤니티에도 배포 가능
- AMI는 리전별 리소스임.

# 8. AMI에서 가상화의 역할

## 8.1 하드웨어 가상화 머신(HVM)

- HVM AMI는 루트 블록 디바이스의 부트 마스터 레코드를 실행한 뒤 운영체제에 하드웨어의 모든 설정 내용을 가상화
- 운영체제는 VM 위에서 바로 실행
- HVM AMI는 하드웨어에 대한 완전한 가상화 환경 제공
- 모든 현 세대 인스턴스 타입은 HVM AMI 지원

## 8.2 부분 가상화(PV)

- PV의 게스트는 호스트 하드웨어 위에서 실행되므로 완벽한 가상화 기능을 제공하지 못하며, HVM에서는 가능한 강화 네트워킹 또는 GPU 프로세싱 등의 기능 활용 불가
- 현 세대 인스턴스 타입은 PV AMI를 지원하지 않음.

# 8. 인스턴스 라이프 사이클

## 8.1 인스턴스 론칭

- 대기중(Pending) 상태
- 헬스 체크 진행 후 실행 중(Running) 상태로 변경됨
- 실행 중 상태가 되면, 인스턴스는 모든 기능이 활성화되고 사용자가 연결할 수 있는 상태가 된다. 이 시점에서 과금 시작

## 8.2 시작 및 정지

- 헬스 체크가 실패하면 인스턴스는 시작되지 않는다.
- 인스턴스 스토어 기반인 경우 정지 동작 사용 불가
- 인스턴스 정지 시 정지 중(Stopping) 상태가 되고 곧 정지됨(Stopped) 상태가 된다.
- EBS 볼륨 요금도 과금됨. 정지 상태 인스턴스는 과금되지 않음.

## 8.3 재부팅

- 재부팅 후에도 EBS 볼륨은 물론 인스턴스 스토어에 저장된 데이터 보존 가능

## 8.4 인스턴스 삭제

- 인스턴스 삭제 시 삭제 중(Shutting Down) 또는 삭제(Terminated) 상태
- 삭제 시 과금 중지
- 삭제 시 연결된 EBS 볼륨도 삭제할 수 있고 남길 수도 있음. 기본 설정 동작은 루트 디바이스 볼륨이 삭제되고 다른 EBS 볼륨은 그대로 유지됨.

## 8.5 인스턴스 폐기

- 인스턴스 호스팅 시 하드웨어에서 복구 불가능한 오류 발생 시 인스턴스 폐기(Retired) 시키거나 폐기 스케줄에 추가함.
- EBS 볼륨 기반 인스턴스인 경우 EBS 볼륨에 모든 데이터가 저장되므로 다른 하드웨어로 옮겨서 다시 인스턴스 실행
- 인스턴스 스토어에 저장된 모든 데이터는 백업 필요

# 9. 인스턴스에 연결

- 퍼블릭 서브넷에서 인스턴스 론칭 시 해당 인스턴스와 인터넷을 연결할 수 있는 퍼블릭 IP 주소와 퍼블릭 DNS 네임이 나타난다.
    - Public DNS(IPv4)
    - IPv4 Public IP
    - Private DNS
    - Private IPs
- SSH 연결

# 10. 시큐리티 그룹

- 인스턴스로 유입되는 인바운드 트래픽과 인스턴스에서 유출되는 아웃바운드 트래픽을 조절

### 시큐리티 그룹 특징

- 기본적으로 모든 아웃바운드 트래픽 허용
- EC2 classic 시큐리티 그룹에 있는 아웃바운드 규칙은 변경 불가
- 시큐리티 그룹은 언제나 허용 여부만 정할 수 있고 거부 여부는 정할 수 없음.
- 스테이트풀 속성을 지님.
    - 인스턴스에서 요청을 보내면, 해당 요청에 대한 응답 트래픽은 시큐리티 그룹의 인바운드 규칙과 무관하게 전달 허용
    - 인바운드 트래픽이 허용된 응답의 경우 아웃바운드 규칙에 상관 없이 유출 허용
- 변경 사항은 짧은 시간 내에 시큐리티 그룹에 연결된 모든 인스턴스에 적용
- 하나의 인스턴스에 여러 개의 시큐리티 그룹을 연결할 경우 각 규칙은 단일 규칙 세트로서 인스턴스에 적용

### 지정할 수 있는 규칙

- 프로토콜
- 포트 범위
- ICMP 타입과 코드
- 소스 및 데스티네이션

## Amazon Elastic Container Service

- Amazon Elastic Container Service(ECS)는 클러스터에서 도커 컨테이너를 관리할 수 있게 해주는 컨테이너 관리 서비스이다.
- 클러스터와 컨테이너 관리의 복잡성 문제를 처리해 사용자가 자신의 클러스터 관리 인프라에 뭔가를 설치하거나 운영할 필요가 없다.
    - 클러스터 관리 소프트웨어를 설치할 필요가 없음.
    - 어떤 규모의 클러스터도 쉽게 관리 가능
    - ECS를 이용해 내오류성 클러스터 아키텍처 설계
    - 클러스터 상태 관리 기능
    - 세밀한 컨테이너 통제 및 모니터링 가능
    - 거의 즉각적으로 하나의 컨테이너에서 수만개의 컨테이너로 확장 가능
    - 컨테이너 배치 위치에 대한 의사 결정 지원
    - 리소스 가용성 정보 제공
    - EC2 Auto Scaling을 이용해 언제든 클러스터에 새 리소스 추가 가능
    - AWS의 다양한 서비스와 통합 사용 가능