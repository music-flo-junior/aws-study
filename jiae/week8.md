# 8. AWS 데이터베이스

## 8.1 Amazon RDS

### 8.1.1 관계형 데이터베이스의 개요

- 관계형 데이터베이스에서 정보는 열과 행으로 이루어진 테이블에 저장
- 모든 작업에 SQL 사용
- 널리 사용되는 RDBMS는 Oracle, MySQL, PostgreSQL, MariaDB 등이 있음

### 8.1.2 Amazon RDS의 개요

- 지원하는 RDBMS 엔진: Aurora MySQL Aurora PostgreSQL, Oracle, SQL Server MySQL, PostgreSQL, MariaDB
- AWS에서는 EC2서버 혹은 Amazon RDS에서 관계형 데이터베이스 호스팅 가능

**시나리오1: 온프레미스 데이터 센터에 데이터베이스 호스팅**

전원장치부터 네트워크, 서버, 운영체제, 스토리지 환경, RDBMS 설치, OS 유지 및 펌웨어 업그레이드, 데이터베이스 소프트웨어 업그레이드, 앱 최적화 등의 데이터 센터 운영을 위한 제반 업무를 모두 수행

**시나리오2: AmazonEC2 서버에 데이터베이스 호스팅**

AWS에서 OS 설치, 서버 유지 보수, 랙 관리, 전원 관리, 냉각 관리, 네트워크 관리 등의 업무 처리
사용자는 OS 관리, RDBMS 설치에 필요한 OS 패치, 데이터베이스 설치 및 유지보수, 데이터베이스 및 애플리케이션 최적화 업무 수행

시나리오3: Amazon RDS를 이용해 데이터베이스 호스팅

인프라 관리 불필요, 즉각적인 프로비저닝, 확장성 관리, 비용 효율성, 애플리케이션 호환성, 고가용성, 보안 유지 등의 장점이 있음. 사용자는 애플리케이션 최적화에만 집중

### 8.1.3 데이터베이스 호스팅: Amazon EC2 대 Amazon RDS 비교

- RDS를 사용하면 좋은 경우
    - 비즈니스 본연의 가치에 집중하려는 경우
    - 데이터베이스 관리 업무를 원치 않는 경우
    - 하이 레벨 튜닝 및 스키마 최적화 등의 업무만 처리하려는 경우
    - 회사 내 데이터베이스 관리 역량이 충분치 않은 경우
    - 푸시 기반 다중 AZ 복제 환경을 이용하려는 경우
    - 백업 및 복원 자동화를 원하는 경우
- EC2를 추천하는 경우
    - 데이터베이스 인스턴스에 대한 완전한 통제권을 원하는 경우
    - 운영체제 시스템에 대한 통제권을 원하는 경우
    - 백업, 복제, 클러스터링 등에 대한 완전한 통제권을 원하는 경우
    - 기업의 RDBMS 엔진의 주요 기능과 옵션이 Amazon RDS와 맞지 않는 경우
    - 기업에서 요구하는 용량 및 성능이 Amazon RDS의 제공 수준을 넘어서는 경우
        - MySQL, SQL Server, MariaDB, PostgreSQL, Oracle 스토리지 제한 16TB
        - Aurora DB 64TB

### 8.1.4 Amazon RDS에서의 고가용성 구현

데이터베이스는 기본적으로 HA 아키텍처를 따른다. (잠시라도 DB가 장애가 나면 앱이 통째로 장애이므로)

**가장 단순한 아키텍처: 싱글 AZ 배포**

개발기, 클라우드 경험 쌓는 용이라면 싱글 AZ 환경에 RDS를 사용할수 있다.


**고가용성 아키텍처: 멀티 AZ 배포**


멀티 AZ 아키텍처는 마스터 데이터베이스가 모든 트래픽을 처리하고 스탠바이 데이터베이스는 마스터의 셧다운 상황을 대비해 데이터를 동기적으로 스탠바이 스토리지에 복제한다.

장애 발생 시 스탠바이 데이터베이스가 모든 트래픽을 처리하며, DNS 엔드포인트를 이용해 DB를 연결한다.

### 8.1.5 Amazon RDS에서의 확장성 구현

**인스턴스 타입 변경**

- 확장성 조절을 위해 가장 간단한 방법은 인스턴스 타입을 변경하는 것이다.
- RDS에서도 원하는 인스턴스 클래스를 선택해 적용할 수 있다. 즉시 적용 시 짧은 가동 정지 시간이 있을 수 있다.
- 람다를 통해 스케일 인/업에 대한 자동화 작업을 처리할 수도 있다.

**읽기 사본 활용**

- read-only 데이터베이스는 마스터와 동기화 상태를 유지한다. RDS는 RDBMS 엔진에 따라 최대 15개의 읽기 사본을 지닐 수 있다.
- 읽기 사본을 통해 read-only 트래픽 부하를 분산시킬 수 있다. 마스터는 중요한 트랜잭션 쿼리에 집중한다.
- 사용자가 다른 국가에 있는 경우 해당 국가의 리전에 읽기 사본을 둬 read-only 트래픽 부담을 줄일 수 있다. (크로스 리전 읽기 사본 및 교차 리전 읽기 사본)
- 마스터 셧다운 시 읽기 사본이 마스터 데이터베이스로 승격될 수 있다.

### 8.1.6 Amazon RDS에서의 보안성 구현

**Amazon VPC와 Amazon RDS**

데이터베이스는 항상 방화벽으로 보호해야 하므로 처음부터 프라이빗 서브넷 내에 생성하는 것이 좋다. VPC 내에서 실행되는 데이터베이스를 연결하는 방법은 다음과 같다.

- VPC 내에 구현된 데이터 센터를 VPN으로 연결해 하이브리드 방식으로 데이터베이스를 연결한다.
- Direct Connect로 데이터 센터와 AWS 리전을 연결한다.
- 두 개의 VPC 피어 방식으로 연결한 뒤 하나의 VPC에는 애플리케이션을 두고 다른 VPC에는 데이터베이스를 두고 연결한다.
- VPC에 Internal Gateway를 부착하고, 이를 통해 데이터베이스에 대한 퍼블릭 접근을 허용할 수 있다.
- VPC에 부착한 서브넷 라우트 테이블을 이용해 VPC의 라우팅 방식을 정의할 수 있다.

**Amazon RDS에서의 데이터 암호화**

RDS의 데이터베이스 암호화에는 다음 항목이 포함된다. (AES-256 암호화 알고리즘 사용)

- 데이터베이스 인스턴스 스토리지 암호화
- 자동화된 백업 암호화
- 마스터 데이터베이스의 읽기 사본 암호화
- 마스터 데이터베이스의 스탠바이 데이터베이스 암호화
- 데이터베이스로 생성한 스냅샷 암호화

암호화 기능 활성화 시 AWS KMS 내에 RDS를 위한 기본 키가 생성되어 암복호화에 사용된다.

**RDS 2 티어 키**

- RDS 데이터 키: RDS 내 데이터 암호화
- AWS KMS 마스터 키: 데이터 키 암호화


### 8.1.7 백업, 복구, 스냅샷

- Aurora를 제외한 모든 Amazon RDS는 하루 한번 백업을 실시한다. 백업 과정을 모니터링 할 수 있고 백업 대상은 전체 데이터베이스, 전송 로그, 변경 로그 등이 포함된다. 백업 보존 기간은 35일이다.
- S3에 백업이 저장된다. 사용자는 복원을 원할 때 복원 장소와 복원 시기만 선택하면 기존 데이터가 모두 채워진 RDS 인스턴스가 생성된다.

### 8.1.8 모니터링

RDS에서 실행되는 데이터 베이스를 모니터링 할 수 있는 다양한 방법

RDS는 모니터링된 모든 성능 지표를 CloudWatch로 전송하고, 사용자는 이를 RDS 콘솔 또는 CloudWatch 콘솔 혹은 CloudWatch API로 확인할 수 있다.

- 표준 모니터링: CPU 이용률, 스토리지, 메모리, 스왑 사용량, 데이터베이스 연결, I/O, 지연, 처리 성능, 읽기 사본 처리 지연 등
- 강화 모니터링: 세분화된 성능 지표
- 이벤트 노티피케이션: RDS에 변화가 감지되면 SNS를 통해 노티피케이션 전송
- 퍼포먼스 인사이트: 데이터베이스 성능 시각화

## 8.2 Amazon Aurora

Amazon Aurora는 클라우드에 최적화된 MySQL 및 PostgreSQL 호환 관계형 데이터베이스이다.

- MySQL 호환 타입: InnoDB 스토리지 엔진을 사용하는 5.6, 5.7 버전과 호환
- PostgreSQL 호환 타입: 9.6 버전 호환

Aurora가 동시에 모든 데이터를 S3에 지속적으로 백업돼 신뢰성 및 가용성을 제공한다. 아래는 세 개의 AZ에 Aurora 스토리지를 복제하는 과정.


## 8.3 Amazon Redshift

Amazon Redshift는 관리형 데이터 웨어하우스 솔루션이다. 보통 데이터베이스가 트랜잭션 데이터 처리에 초점을 맞추는 반면 데이터 웨어하우스는 데이터 쿼리 및 분석에 초점을 맞춘다. 즉, 데이터 웨어하우스는 읽기 중심의 데이터 처리 시스템으로 쓰기나 업데이트에 비해 읽기 처리 능력이 월등히 높다.

### 8.3.1 Amazon RedShift의 장점

- 신속성
- 저렴함
- 우수한 압축성
- 관리형 서비스
- 확장성
- 보안성
- 존 맵 기능

### 8.3.2 Amazon Redshift 아키텍처


- 리더 노드
    - 애플리케이션의 SQL 엔드포인트
    - 데이터베이스로서의 기능 및 병렬적인 SQL 처리 업무 조정
- 컴퓨트 노드
    - 쿼리 처리 시 리더 노드는 컴퓨트 노드와 소통하며 컴퓨트 노드가 실제 데이터를 처리한다.

**백업 및 복구**

- Amazon Redshift는 클러스터의 스냅샷 형태로 자동화된 백업을 생성하며 이를 S3에 저장한다. 사용자는 스냅샷을 통해 전체 데이터베이스가 아닌 테이블 레벨로 데이터를 복원할 수 있다.

**Amazon Redshift에서 데이터 로딩하기**

클러스터에 데이터를 로딩하는 방법은 다양하며 S3에서 파일 기반 로딩 기법으로 직접 데이터를 로딩할 수 있다. 혹은 Kiness Firehose를 이용해 직접 배치 데이터 또는 스트리밍 데이터를 도으할 수도 있다. 직접 노드에 SQL  COPY 명령을 통해 데이터를 삽입할 수도 있다.

**Amazon Redshift의 데이터 배분 전략**

클러스터 내 여러 노드에 데이터를 배분하는 옵션: EVEN, KEY, ALL

## 8.4 Amazon DynamoDB

Amazon DynamoDB는 확장성 및 개발의 신속성을 제공하는 고성능의 완전 관리형 NoSQL 데이터베이스다.

DynamoDB는 도큐먼트 구조 및 키 밸류 데이터 구조를 모두 제공한다.

### 8.4.1 DynamoDB의 장점

- 확장성
- 관리형 서비스
- 신속성, 일관된 성능
- 세분화된 접근 제어
- 비용 효율성
- 다른 AWS 서비스와의 통합

DynamoDB는 API를 통해 테이블 및 아이템을 생성, 갱신, 삭제 할 수 있다. 테이블 생성 시 사용자는 기본 키를 지정해야 한다.

- DynamoDB에서 제공하는 두 가지 기본 키
    - 파티션 키: 단순 기본 키
    - 파티션 키와 정렬 키 조합: 복합 기본 키 (첫 번째 속성은 파티션 키, 두 번째 속성은 정렬 키)

### 8.4.2 보조 인덱스

파티션 키 또는 파티션 정렬 키를 포함한 인덱스로, 테이블 내 데이터에 대한 효율적인 접근을 위해 DynamoDB는 기본 키 속성의 인덱스를 생성 및 유지

- 지역 보조 인덱스: 파티션 키는 같지만 정렬 키가 다른 인덱스
- 전역 보조 인덱스: 파티션 및 정렬 키가 모두 다른 인덱스

### 8.4.3 일관성 모델

DynamoDB는 각 테이블마다 세 개의 다른 지역에 사본을 분산 저장해 고가용성, 고신뢰성을 유지한다.

- 최종적 일관성의 읽기
    - 읽기와 관련된 기본 설정 모델로 읽기 처리 성능 최대화
    - 최신 완료된 쓰기 결과를 반영하지 못할 수 있음. 1초 내에 모든 데이터 사본의 일관성이 보장되지만 읽기 작업 반복 수행 시 최신 내용 갱신에 약간의 지연 발생
- 강한 일관성의 읽기
    - 필요에 따라 강한 일관성의 읽기 옵션을 제공
    - 읽기 요청에 대해 언제라도 최신의 쓰기 결과가 모두 반영된 결과를 성공적으로 반환

### 8.4.4 글로벌 테이블

DynamoDB의 관리형 멀티 리전. 사용자의 DynamoDB 테이블을 자동으로 복제해 크로스 리전 환경을 구현한다.

### 8.4.5 Amazon DynamoDB Streams

개발자는 DynamoDB Stream API를 통해 최신 데이터를 가져오거나 아이템 레벨의 데이터 확보 가능

### 8.4.6 Amazon DynamoDB Accelerator

DAX는 완전 관리형, 고가용성, 인메모리 캐시 서비스로 최대 10배 높은 성능 개선을 통해 초당 수백만 건의 조회 요청을 처리할 수 있다.

### 8.4.7 암호화 및 보안

KMS 암호화 키를 통해 DynamoDB 데이터를 보다 안전하게 관리 가능

## 8.5 Amazon ElastiCache

Amazon ElastiCache는 클라우드에서 인메모리 캐시를 배포, 운영, 확장하기 위한 웹 서비스이다.

ElasticCache는 샤딩 기법을 통해 메모리 확장성을 관리한다

사용자는 읽기 성능 향상을 위해 다수의 사본을 생성할 수 있다.

ElasticCache는 두 가지 종류의 인메모리 키밸류 엔진을 지원한다.

- Memcached: 인메모리 키 스토어로 웹 캐싱의 표준이라 불린다. 멀티 스레드 기능을 제공하여 다중 코어로 지닌 대규모 EC2 인스턴스를 활용할 수 있다.
- Redis: 오픈소스 키 밸류 스토어로 정렬 세트, 해시, 리스트 등 더 많은 고급 데이터 구조를 지원한다. Redis는 Memcached와 달리 디스크 지속 기능을 내장하고 있어서 데이터를 오래 유지할 수 있다. 다중 AZ 중복 구현에도 활용된다.

Redis는 복제 및 디스크 지속성 등의 기능을 이용해 관게형 데이터베이스처럼 활용되며 ElasticCache 클러스터는 스테이트풀 개체로 관리된다.

애플리케이션 서버가 있는 AZ에 Elasticache 클러스터를 함께 두는 것이 성능상 좋다. 특정 AZ에 ElastiCache 클러스터를 론칭하려면 생성 시 반드시 Preffered Zone 옵션을 설정한다.

## 8.6 Amazon Neptune

- 완전 관리형 그래프 데이터베이스 서비스로 수십억 개의 노드와 관련성을 지닌 그래프 구조 데이터의 저장 및 쿼리에 사용
- Neptune은 데이터세트의 관련성을 저장하고 순회하는 데 최적화되어 NoSQL보다 훨씬 풍부한 상호 연결 데이터의 속성을 활용
- Property Graph 모델, RDF 모델 및 전용 쿼리 지원

### 8.6.1 Neptune의 장점

- 완전 관리형
- 확장성
- 고가용성 및 내오류성
- ACID 조건 충족
- 보안성

### 8.6.2 Neptune 활용 전략

- 소셜 네트워크 구현
- 추천 시스템 구현
- 지식 그래프 구현
- 네트워크/IT 운영 및 데이터 센터 관리
- 생명 과학 연구
- 경로 최적화 연구
- 사기 행위 분석

## 8.7 Amazon DocumentDB

MongoDB 워크로드 처리를 지원하는 완전 관리형 데이터베이스 서비스로 JSON 데이터의 저장, 쿼리, 인덱스 작업을 수행

### 8.7.1 DocumentDB 장점

- 고가용성
- 고성능
- 고도의 보안성
- 완전 관리형

### 8.7.2 DocumentDB 활용 전략

- 사용자 프로필 정의
- 실시간 빅데이터 처리
- 콘텐츠 관리
- 모바일 및 웹 어플리케이션