# 3. Amazon Virtual Private Cloud(VPC)

## 1. Virtual Private Cloud 개요

### 1.1 VPC란?

- 3티어 어플리케이션: 웹 티어, 앱티어, 데이터베이스 티어
    - 데이터베이스, 앱 티어(?): 프라이빗 서브넷 속에 있어서 인터넷으로 접근 불가
    - 웹 티어: 인터넷으로 접근 가능
- **Amazon VPC는 사용자를 위한 Virtual Private Cloud 서비스로 클라우드를 퍼블릭과 프라이빗 영역으로 논리적으로 분리 가능**
- 자체 IP 주소, 자체 IP 범위, 프라이빗 및 퍼블릭 서브넷, 라우트 테이블, 네트워크 게이트웨이 등 모든 기능 활용 가능

### 1.2 VPC로 가능한 일

- 애플리케이션 중 일부는 VPC 내 클라우드에서 실행하고, 일부는 온프레미스에서 실행할 수 있다.
- VPC 내에서 다수의 서브넷을 생성할 수 있다. 인터넷 접근을 위한 퍼블릭 서브넷을 생성하고, 격리된 접근을 위한 프라이빗 서브넷을 생성할 수 있다.
- Direct Connect를 이용해 기업 데이터 센터와 VPN를 전용 회선으로 연결할 수 있고, 암호화되노 IPsec 연결을 통해 하드웨어 기반 VPN으로 기업 데이터 센터를 연결할 수 있다.
- 하나 이상의 VPC가 필요하다면 다수의 VPC를 생성한 뒤 VPC 피어링을 통해 서로 연결할 수 있다.
- VPC 엔드포인트를 사용해 S3와 같은 리소스에 연결할 수 있다.

## 2. Virtual Private Cloud 주요 구성 요소와 주요 용어

### 2.1 Amazon VPC

클라우드 내 프라이빗 공간을 제공한다. VPC를 생성하면 클라우드에 기업 전용 데이터 센터를 구축할 수 있다.

**VPC 생성 단계**

CIDR(Classless Inter Domain Routing) 블록을 이용한 CIDR 범위 결정

1. IPv4, IPv6 선택 가능. 한번 생성한 VPC는 주소의 크기를 변경할 수 없다.
2. IPv4
    1. /16 사이의 범위, 즉 65,536 IP 주소 사용 가능. 주소 범위 필수 선택
3. IPv6
    1. CIDR 블록 크기는 /56 고정. 주소와 범위는 아마존에 의해 자동 할당

VPC는 리전에 제한되고, 다른 리전으로 확장할 수 없으며, VPC 내에서 동일 리전의 AZ를 포함시킬 수 있다.

### 2.2 서브넷

서브넷은 서브네트워크(Subnetwork)의 줄임말로 IP 네트워크의 논리적인 하위 부분을 가리킨다.

서브넷을 통해 하나의 네트워크를 여러 개로 나눌 수 있다.

- 퍼블릿 서브넷: 인터넷을 통해 연결할 수 있는 리소스를 위한 것
- 프라이빗 서브넷: 보안 유지를 위한 배타적인 연결에 사용
- VPN 온리 서브넷: 기업 데이터 센터와 Virtual Private Cloud를 연결하는 데 사용

<aside>
💡 **서브넷은 AZ 단위로 생성**된다. 여러 개의 AZ가 있으면 여러 개의 서브넷을 생성한다.
**VPC는 리전 단위로 생성**된다. 여러 개의 리전이 있다면 여러 개의 VPC를 생성한다.

</aside>

VPC를 생성할 때에는 VPC의 IP 주소 범위를 나타내는 CIDR 블록을 정의해야한다. 자세한 CIDR 설명과 계산은 아래를 참고한다.

[사이더 (네트워킹) - 위키백과, 우리 모두의 백과사전](https://ko.wikipedia.org/wiki/%EC%82%AC%EC%9D%B4%EB%8D%94_(%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9))

[CIDR / VLSM Supernet Calculator](https://www.subnet-calculator.com/cidr.php)

### 2.3 라우트 테이블

 라우트 테이블(Route Table)은 트래픽의 전송 방향을 결정하는 라우트와 관련된 규칙을 담은 테이블이며, 목적지를 향한 최적의 경로로 데이터 패킷을 전송하기 위한 모든 정보를 담고 있다.

 각각의 서브넷은 항상 라우트 테이블을 지니고 있어야 하지만, 하나의 라우트 테이블 규칙을 여러 개의 서브넷에 연결하는 것은 가능하다.

라우트 테이블은 대상 주소와 대상, 두 가지 정보로 구성된다. 대상은 트래픽이 향하는 장소이고, 대상 주소는 대상으로 향하는 IP 범위를 지정한다


### 2.4 인터넷 게이트웨이

인터넷 게이트웨이(IG, Internal Gateway)는 VPC가 인터넷으로 연결되도록 하는 요소이다. 서브넷에서 인터넷으로 바로 연결할 수 있다.

### 2.5 인터넷 주소 변환 (NAT)

 실제 개발 환경에서는 용도에 따라 일부는 퍼블릭 속성으로 다른 일부는 프라이빗 속성으로 서브넷을 생성한다. 프라이빗 서브넷에 데이터베이스를 생성하는 경우 인터넷을 통해서 해당 데이터베이스에 접근할 수 없다는 의미이며, 외부와 완전히 격리된다는 의미이기도 하다.

 NAT 디바이스를 이용하면 기본적으로 인터넷 접속 불능으로 설정된 프라이빗 서브넷에 있는 서버 인스턴스를 인터넷에 연결할 수 있다.

NAT 기기는 IPv4 트래픽에만 사용할 수 있고, IPv6 용으로는 사용할 수 없다.

- AWS의 NAT 기기 타입
    - NAT 인스턴스
    - NAT 게이트웨이

### 2.5.1 NAT 인스턴스

퍼블릭 서브넷에서 NAT 인스턴스를 이용할 때는 프라이빗 서브넷에서 인터넷 또는 다른 AWS로 트래픽을 보낼 수 있다. (퍼블릭 서브넷에서 NAT 인스턴스를 생성하면, 퍼블릭 IP 주소 또는 엘라스틱 IP 주소가 필요)

NAT를 통해 프라이빗 서버에서 인터넷으로 연결해서 뭔가 다운받거나 연결하는 것은 가능하지만 반대방향(인터넷 → 프라이빗)의 트래픽 이동은 불가능하다.

### 2.5.2 NAT 게이트웨이

NAT 게이트웨이는 기본적으로 NAT 인스턴스와 동일한 기능을 수행하지만 NAT 인스턴스가 하지 못하는 일을 할 수 있다.

NAT 게이트웨이는 특정 AZ에 이중화 또는 중복 구현 방식으로 생성

실무에서는 NAT 인스턴스보다 NAT 게이트웨이를 선호. NAT 게이트웨이의 가용성 및 네트워크 대역이 보다 높기 때문.

### 2.6 외부 전용 인터넷 게이트웨이

외부 전용(Egress-Only) 인터넷 게이트웨이는 NAT 게이트웨이와 비슷한 기능을 수행

IPv6 서브넷 내부에서 외부로 나가는 아웃바운드만 가능

### 2.7 탄력적 네트워크 인터페이스

탄력적 네트워크 인터페이스(ENI, Elastic Network Interfaace)는 하나 혹은 다수의 네트워크 인터페이스를 생성하고 인스턴스에 붙이는 역할을 담당한다.

- ENI의 주요 속성
    - MAC 주소
    - 하나의 퍼블릭 IPv4 주소
    - 프라이머리 프라이빗 IPv4 주소
    - 하나 또는 그 이상의 세컨더리 프라이빗 IPv4 주소
    - 프라이빗 IPv4 주소별 엘라스틱 IP 주소(IPv4)
    - 인스턴스를 론칭할 때 네트워크 인터페이스 eth0에 자동으로 할당될 수 있는 하나의 퍼블릭 IPv4 주소
    - 하나 또는 그 이상의 시큐리티 그룹
    - 소스/대상 주소 체크 플래그 및 명세

프라이빗 네트워크 인터페이스(eth0)은 인스턴스에서 분리하거나 변경 불가

네트워크 인터페이스는 필요한 만큼 생성 가능.

ENI의 수는 인스턴스로 향하는 네트워크 대역폭 또는 전송용량에는 영향을 주지 않는다. (ENI의 수를 늘려도 네트워크 전송용량이 늘어나지 않는다.)

### 2.8 Linux에서 향상된 네트워크(리눅스만 가능)

Linux에서 향상된 네트워킹은 어플리케이션 실행에 있어 매우 낮은 지연성, 고아대역폭, 고송 PPS(Packet-Per-Second) 성능이 요구되는 경우에 사용

- Elastic Network Adapter(ENA)를 사용하는 경우
    - 최대 100Gbps 네트워크 지원
- Inte; 82599 Virtual Function(VF) 인터페이스를 사용하는 경우
    - 최대 10Gbps 네트워크 지원

### 2.9 엘라스틱 IP 주소 (EIP)

EIP는 클라우드에서 실행되는 애플리케이션을 위한 주소 체계다. (정적 IP 주소)

IP 주소를 바꾸는 대신 EIP를 받아서 해당 EC2인스턴스와 연결하고 이 EIP를 애플리케이션에 연결하는 방식이 자주 사용된다.

IPv4만 지원하고 IPv6은 지원하지 않는다. 

> 실행 중인 인스턴스에 연결된 EIP에 대한 비용은 무료다. 계정에서 EIP를 생성하고 특정 인스턴스에 연결하지 않으면 EIP에 대한 비용이 부과될 수 있다. 또한 EIP는 특정 리전 내에서만 사용할 수 있다.


## 네트워크 보안

네트워크 보안은 시큐리티 그룹 및 네트워크 접근 제어 목록(NACL, Network Access Control List)를 통해 구현할 수 있다.

### 2.10 시큐리티 그룹

- 시큐리티 그룹은 VPC에서 실행되는 어떤 인스턴스에도 할당할 수 있는 가상 방화벽이다.
- 특정 인스턴스의 내부 또는 외부로 이동하는 트래픽을 정의한다.
- 서브넷이 아닌 인스턴스 레벨에서 작동한다.
- 인스턴스 별로 최대 5개의 시큐리티 그룹을 부여할 수 있다. 또 서로 다른 인스턴스에 동일한 시큐리티 그룹을 부여하는 것도 가능하다.
- 시큐리티 그룹은 스테이트풀 속성을 지니며 IP 주소, 포트, 트래픽의 인바운드 및 아웃바운드에 대한 규칙을 정의한 프로토콜 등으로 구성된다.
- 시큐리티 그룹은 언제라도 트래픽의 접근 허용 또는 거절 규칙을 변경할 수 있지만, 사용자는 오직 접근 허용 규칙만 추가할 수 있고 접근 거절 규칙은 작성할 수 없다.
- VPC는 항상 기본 시큐리티 그룹을 포함하고 있으며, EC2 인스턴스 생성 시 별도의 지정을 하지 않아도 자동으로 해당 VPC의 시큐리티 그룹과 연결된다.

### 2.11 네트워크 엑세스 제어 목록

VPC의 서브넷 레벨에 적용할 수 있는 추가적인 방화벽인 네트워크 엑세스 제어 목록(NACL)은 IP 주소, 포트, 프로토콜, 서브넷 허용/거부 규칙을 통합한 스테이트리스 속성의 방화벽 서비스이다.

- **시큐리티 그룹과 NACL의 차이점**
    - 시큐리티 그룹
        - 인스턴스 레벨에 적용
        - 스테이트풀(리턴 트래픽을 기본적으로 허용)
        - 허용 규칙만 추가
        - 모든 규칙은 트래픽 허용 전에 평가받는다.
    - NACL
        - 서브넷 레벨에 적용
        - 스테이트리스(리턴 트래픽을 기본적으로 거부)
        - 허용 및 거부 규칙 모두 추가 가능
        - 순번에 따라 우선순위로 트래픽 허용을 평가받는다.
- 시큐리티 그룹 규칙 개수 제한
    - 리전 당 VPC마다 500개의 시큐리티 그룹 생성 가능
    - 각 시큐리티 그룹마다 각각 50개의 인바운드 및 아웃바운드 규칙 추가 가능
    - 네트워크 인터페이스 당 최대 시큐리티 그룹 수는 5개, AWS Support 요청을 통해 16개 까지 추가 가능
    

## 3. 다수의 Virtual Private Cloud 연결 방법

### 3.1 Amazon VPC 피어링

- VPC 피어링은 하나의 VPC를 또 다른 VPC에 연결하고, 프라이빗 IPv4 또는 IPv6 주소를 통해 서로의 트래픽을 교환하기 위한 방법
- VPC 피어링은 동일 리전에서만 가능하며, 리전 간의 피어링은 불가능
- VPC 피어링은 두 VPC 간의 일대일 피어링 관계 생성이다.

### 3.2 Amazon VPC 엔드포인트

S3를 VPC 와 연결하려면 인터넷과 데이터 센터 전용 네트워크 두 개를 함께 연결해야 한다.

VPC 엔드포인트는 이런 목적으로 만들어져 S3와 VPC를 프라이빗하게 연결한다.

VPC는 모든 네트워크 트래픽을 AWS 내부에서 처리하는 AWS Private Link를 사용한다.

PrivateLink를 사용하는 AWS 서비스의 엔드포인트를 생성하면 private IP를 지닌 ENI로 표시되어 NAT, 방화벽 등을 관리할 필요가 없다.

VPC 엔드포인트는 인터페이스 엔드포인트, 게이트웨이 엔드포인트 등, 두 가지 유형이 있다.

- 인터페이스 엔드포인트
    - 프라이빗 IP 주소를 지닌 ENI로 서비스의 트래픽을 처리하는 엔트리 포인트가 되는 서브넷의 IP 주소를 사용한다.
    - 50여개 이상의 서비스(AWS 관리형 서비스, MarketPlace 서비스 등)가 지원한다.
- 게이트웨이 엔드포인트
    - AWS 서비스의 트래픽을 정의하는 라우트 테이블에서 타깃으로 설정할 수 있으며 S3 및 DynamoDB 가 게이트웨이 엔드포인트를 지원한다.

### 3.3 Transit Gateway

Transit Gateway를 이용하면 네트워크 전송 허브를 이용해 VPC와 온프레미스 네트워크를 연결할 수 있다.

Transit Gatway에 다음과 같은 리소스를 추가할 수 있다.

- 하나 이상의 VPC
- 하나 이상의 VPC 연결 객체
- 하나 이상의 AWS Direct Connect 게이트웨이
- 하나 이상의 Transist Gateway 피어링 연결 객체

### 3.4 DNS와 VPC

Domain Name System(DNS)는 인터넷을 위한 전화번호부라고 할 수 있다.

아마존의 DNS 서버는 VPC 내에서 실행 중인 모든 인스턴스의 주소를 관리한다.

### 3.5 DHCP 옵션 세트

DHCP(Dynamic Host Configuration Protocol) 옵션 세트는 기본 도메인 네임, DNS 서버 등 VPC에 있는 인스턴스의 호스트 환경 설정에 사용된다.

VPC에 있는 모든 인스턴스는 해당 도메인 네임을 통해 특정 도메인 또는 DNS를 가리킬 수 있게 된다.

아마존은 VPC 생성 시 자동으로 DHCP 옵션 세트를 추가하며, 도메인 네임 서버가 기본적으로 AmazonProvidedDNS를 가리키도록 하는 옵션과 리전에 대한 도메인 네임 옵션을 함께 제공한다.

- DHCP 옵션 필드의 환경 설정 파라미터
    - domain-name-services
    - domain-name
    - ntp-server
    - netbios-name-servers
    - netbios-node-type

## 4. 기업 데이터 센터와 Amazon Virtual Private Cloud 연결 방법

### 4.1 VPC와 기업의 데이터 센터를 연결하는 방법

- 버추얼 프라이빗 게이트웨이(Virtual Private Gateway)
    - 기업 데이터 센터와 VPC에서 생성된 인스턴스가 소통할 수 있게 하려면 VPC에 버추얼 프라이빗 게이트웨이(VPG)를 부착한 뒤 커스텀 라우트 테이블을 작성하고, 시큐리티 그룹 규칙을 업데이트 한다.
- 커스터머 게이트웨이(Customer Gateway)
    - 기업 데이터 센터 측 또는 VPN 연결 부분에 있는 물리적 디바이스나 소프트웨어이다. 기업 데이터 센터 측에서 연결된 부분의 앵커와 같은 역할을 담당한다.

### 4.2 VPC와 데이터센터를 연결하기 위한 네 가지 주요 프라이빗 연결 옵션

- AWS 하드웨어 VPN
    - VPC와 리모트 네트워크를 연결하기 위해 하드웨어 VPN dusrufdls IPsec을 생성할 수 있다.
- AWS Direct Connet
    - AWS Direct Connect는 기업 데이터 센터에서 VPC로 연결되는 전용 프라이빗 연결 서비스이다.
- VPN Cloud Hub
    - VPC를 통해 여러 개의 AWS Hardware VPN 연결을 생성해 커뮤니케이션을 할 수 있다.
- Software VPN
    - Software VPN 장비가 부착된 VPC 내의 EC2 인스턴스를 이용해 원격 네트워크로 연결되는 VPN 연결을 생성할 수 있다.

### VCP 흐름 로그

VPC에서 네트워크 인터페이스로 들어오고 나가는 IP 트래픽에 대한 정보를 확인할 수 있다.

## 5. 기본 설정 VPC

- 다이나믹 프라이빗 IP
- 다이나믹 퍼블릭 IP
- AWS 제공 DNS 네임
- 프라이빗 DNS 네임
- 퍼블릭 DNS 네임

기본 설정 VPC를 통해 아래와 같은 일을 할 수 있다.

- 서브넷 추가 생성 및 라우트 테이블 규칙 변경
- 시큐리티 그룹, NACL, 라우팅 등 네트워크 컨트롤 추가 생성
- 기업 네트워크 간 Hardware VPN 옵션 설정